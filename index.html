<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Daily Hisab</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{font-family:Arial;background:#f4f6f8;margin:0}
.header{background:#222;color:#fff;padding:12px 20px;font-size:20px}
.container{max-width:1000px;margin:15px auto;background:#fff;padding:20px;border-radius:8px}
.section{font-weight:bold;margin:18px 0 10px}
.row{display:grid;grid-template-columns:1.2fr 1fr 1fr;gap:8px;margin-bottom:6px}
.row label{font-weight:normal}
.row input{padding:6px}
.total{font-weight:bold;margin-top:8px}
button{background:#222;color:#fff;border:none;padding:8px 14px;border-radius:4px;cursor:pointer}
.box{background:#f1f1f1;padding:10px;border-radius:6px;margin-bottom:10px}
.info{background:#e8ffe8;padding:10px;border-radius:6px;margin-bottom:10px}
</style>
</head>

<body>

<div class="header">üìä Daily Hisab</div>

<!-- PREVIOUS SAVING -->
<div class="container box">
<b>Previous Saving</b><br>
Cash ‚Çπ <input id="prevCashInput" readonly>
Online ‚Çπ <input id="prevOnlineInput" readonly>
Total ‚Çπ <span id="prevTotal">0</span>
</div>

<!-- WEEKLY INFO -->
<div class="container info">
<b>Weekly Info</b><br>
<span id="weeklyInfo">‚Äì</span>
</div>

<div class="container">

<div class="section">Date</div>
<input type="date" id="date">

<div class="section">---- Investment (Cash / Online) ----</div>
<div class="row"><label>Item</label><label>Cash</label><label>Online</label></div>

<div class="row"><label>Chicken</label><input class="invCash" id="ChickenCash"><input class="invOnline" id="ChickenOnline"></div>
<div class="row"><label>Dairy</label><input class="invCash" id="DairyCash"><input class="invOnline" id="DairyOnline"></div>
<div class="row"><label>Grocery</label><input class="invCash" id="GroceryCash"><input class="invOnline" id="GroceryOnline"></div>
<div class="row"><label>Sabji</label><input class="invCash" id="SabjiCash"><input class="invOnline" id="SabjiOnline"></div>
<div class="row"><label>Disposal</label><input class="invCash" id="DisposalCash"><input class="invOnline" id="DisposalOnline"></div>
<div class="row"><label>Gas</label><input class="invCash" id="GasCash"><input class="invOnline" id="GasOnline"></div>
<div class="row"><label>Diesel</label><input class="invCash" id="DieselCash"><input class="invOnline" id="DieselOnline"></div>
<div class="row"><label>Petrol</label><input class="invCash" id="PetrolCash"><input class="invOnline" id="PetrolOnline"></div>
<div class="row"><label>Egg</label><input class="invCash" id="EggCash"><input class="invOnline" id="EggOnline"></div>
<div class="row"><label>Sachin Salary</label><input class="invCash" id="SachinCash"><input class="invOnline" id="SachinOnline"></div>
<div class="row"><label>Sattu Salary</label><input class="invCash" id="SattuCash"><input class="invOnline" id="SattuOnline"></div>
<div class="row"><label>Other</label><input class="invCash" id="OtherCash"><input class="invOnline" id="OtherOnline"></div>

<p class="total">
Investment Cash ‚Çπ <span id="invCashTotal">0</span> |
Investment Online ‚Çπ <span id="invOnlineTotal">0</span>
</p>

<div class="section">---- Production ----</div>
Biryani Made (kg): <input id="BiryaniMade">
Fried Made (kg): <input id="FriedMade"><br><br>
Remaining Biryani (kg): <input id="BiryaniLeft">
Remaining Fried (kg): <input id="FriedLeft">

<div class="section">---- Sell ----</div>
Sell Cash: <input id="SellCash">
Sell Online: <input id="SellOnline">
<p class="total">Total Sell ‚Çπ <span id="SellTotal">0</span></p>

<div class="section">---- Current Saving ----</div>
Cash ‚Çπ <span id="CurrentCash">0</span><br>
Online ‚Çπ <span id="CurrentOnline">0</span><br>
<p class="total">Total ‚Çπ <span id="CurrentTotal">0</span></p>


<button onclick="saveDay()">Save / Update Day</button>
<p id="msg"></p>

</div>
  <!-- LOADING POPUP -->
<div id="popupLoader" style="
  display:none;
  position:fixed;
  top:0; left:0;
  width:100%; height:100%;
  background:rgba(0,0,0,0.4);
  z-index:9999;
  align-items:center;
  justify-content:center;
">
  <div style="
    background:#fff;
    padding:20px 30px;
    border-radius:8px;
    font-size:18px;
    font-weight:bold;
  ">
    ‚è≥ Please wait...
  </div>
</div>


<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycby78QG_u65D6IXG_06aqSyRrVVrAEEGFRj9RxRrCq66nzaNdoSl96xbyxPXzZGeyUXG0g/exec";
 let popupLoader = null;   // sirf declare
let activeRequest = 0; 
function num(v){ return Number(v)||0; }
function setInputsDisabled(disabled){
  document.querySelectorAll(
    ".invCash, .invOnline, #SellCash, #SellOnline, #BiryaniMade, #FriedMade, #BiryaniLeft, #FriedLeft"
  ).forEach(i => i.disabled = disabled);
}

function showLoader(text="Please wait..."){
  popupLoader.style.display = "flex";
  popupLoader.querySelector("div").innerText = "‚è≥ " + text;
}

function hideLoader(){
  popupLoader.style.display = "none";
}


function calculate(){
  let invCash=0, invOnline=0;
  document.querySelectorAll(".invCash").forEach(i=>invCash+=num(i.value));
  document.querySelectorAll(".invOnline").forEach(i=>invOnline+=num(i.value));

  invCashTotal.innerText = invCash;
  invOnlineTotal.innerText = invOnline;

  SellTotal.innerText = num(SellCash.value)+num(SellOnline.value);

  let prevCash = num(prevCashInput.value);
  let prevOnline = num(prevOnlineInput.value);

  CurrentCash.innerText = prevCash + num(SellCash.value) - invCash;
  CurrentOnline.innerText = prevOnline + num(SellOnline.value) - invOnline;
  CurrentTotal.innerText = num(CurrentCash.innerText)+num(CurrentOnline.innerText);

  prevTotal.innerText = prevCash + prevOnline;
}

document.querySelectorAll(
  ".invCash, .invOnline, #SellCash, #SellOnline, #BiryaniMade, #FriedMade, #BiryaniLeft, #FriedLeft"
).forEach(i => i.addEventListener("input", calculate));


async function onDateChange(){
  if(!date.value) return;

  const requestId = ++activeRequest;

  setInputsDisabled(true);
  showLoader("Loading data...");

  await new Promise(r => setTimeout(r, 50));

  /* ===== PREVIOUS SAVING ===== */
  const p = await (await fetch(
    SCRIPT_URL + "?prevOf=" + date.value
  )).json();

  if(requestId !== activeRequest){
    hideLoader();
    return;
  }

  prevCashInput.value = p.currentCash || 0;
  prevOnlineInput.value = p.currentOnline || 0;
  prevTotal.innerText =
    num(prevCashInput.value) + num(prevOnlineInput.value);

  /* ===== SAME DATE DATA ===== */
  const d = await (await fetch(
    SCRIPT_URL + "?date=" + date.value
  )).json();

  if(requestId !== activeRequest){
    hideLoader();
    return;
  }

  if(d.status !== "NOT_FOUND"){
    Object.keys(d).forEach(k=>{
      const el = document.getElementById(k);
      if(el) el.value = d[k];
    });
    msg.innerText = "Existing entry loaded";
  } else {
    document.querySelectorAll(
      ".invCash, .invOnline, #SellCash, #SellOnline, #BiryaniMade, #FriedMade, #BiryaniLeft, #FriedLeft"
    ).forEach(i => i.value = "");
    msg.innerText = "New entry";
  }

  hideLoader();
  setInputsDisabled(false);
  calculate();
}


date.addEventListener("change",onDateChange);
async function saveDay(){
  if(!date.value){
    alert("Date select karo");
    return;
  }

  setInputsDisabled(true);
  showLoader("Saving data...");

  const data = { date: date.value };

  document.querySelectorAll("input").forEach(i=>{
    if(i.id && i.type!=="date") data[i.id] = i.value;
  });

  data.CurrentCash = CurrentCash.innerText;
  data.CurrentOnline = CurrentOnline.innerText;
  data.CurrentTotal = CurrentTotal.innerText;
  data.SellTotal = SellTotal.innerText;

  try{
    await fetch(SCRIPT_URL,{
      method:"POST",
      body:JSON.stringify(data)
    });

    msg.innerText = "Saved ‚úî";
  }catch(err){
    msg.innerText = "Error ‚ùå";
  }

 await new Promise(r => setTimeout(r, 300));
hideLoader();
setInputsDisabled(false);

}

window.addEventListener("DOMContentLoaded", () => {
  popupLoader = document.getElementById("popupLoader");
  setInputsDisabled(true); // page load pe inputs band
});


</script>

</body>
</html>











